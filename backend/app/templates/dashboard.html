<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Al-Xorazmiy CRM</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root { --sidebar-width: 260px; --primary-color: #4f46e5; --bg-light: #f3f4f6; --header-height: 60px; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-light); overflow-x: hidden; margin: 0; }
        
        /* GUEST SCREEN (LOCK) */
        .access-denied { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f3f4f6; z-index: 2000; display: none; flex-direction: column; align-items: center; justify-content: center; text-align: center; }

        /* SIDEBAR */
        .sidebar { width: var(--sidebar-width); height: 100vh; position: fixed; left: 0; top: 0; background: white; border-right: 1px solid #e5e7eb; display: flex; flex-direction: column; z-index: 1050; transition: transform 0.3s ease; }
        .brand { padding: 0 20px; height: var(--header-height); border-bottom: 1px solid #f3f4f6; display: flex; justify-content: space-between; align-items: center; }
        .brand-text { font-size: 1.1rem; font-weight: 800; color: var(--primary-color); }
        
        .menu-items { padding: 15px; flex-grow: 1; overflow-y: auto; }
        .menu-btn { width: 100%; text-align: left; padding: 10px 12px; margin-bottom: 4px; border: none; background: transparent; border-radius: 8px; color: #4b5563; font-weight: 500; display: flex; align-items: center; gap: 10px; transition: 0.2s; font-size: 0.9rem; }
        .menu-btn:hover { background: #f3f4f6; color: var(--primary-color); }
        .menu-btn.active { background: #eef2ff; color: var(--primary-color); font-weight: 600; }
        .user-profile { padding: 15px; border-top: 1px solid #e5e7eb; background: #f9fafb; }

        /* CONTENT */
        .main-content { margin-left: var(--sidebar-width); padding: 30px; min-height: 100vh; transition: margin-left 0.3s ease; }
        
        /* MOBILE HEADER */
        .mobile-header { display: none; height: var(--header-height); background: white; border-bottom: 1px solid #e5e7eb; align-items: center; justify-content: space-between; padding: 0 20px; position: fixed; top: 0; left: 0; width: 100%; z-index: 1040; }
        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 1045; opacity: 0; transition: opacity 0.3s; }
        .overlay.active { display: block; opacity: 1; }

        /* LANG SWITCHER (MINI) */
        .lang-mini { font-size: 0.75rem; font-weight: 600; color: #9ca3af; cursor: pointer; text-decoration: none; transition: 0.2s; }
        .lang-mini:hover { color: #6b7280; }
        .lang-mini.active { color: var(--primary-color); font-weight: 800; }
        .lang-sep { color: #e5e7eb; font-size: 0.75rem; margin: 0 4px; }

        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); }
            .sidebar.active { transform: translateX(0); box-shadow: 5px 0 15px rgba(0,0,0,0.2); }
            .mobile-header { display: flex; }
            .main-content { margin-left: 0; padding: 15px; padding-top: calc(var(--header-height) + 15px); }
        }

        /* UI ELEMENTS */
        .card-custom { background: white; border-radius: 12px; border: 1px solid #e5e7eb; box-shadow: 0 1px 3px rgba(0,0,0,0.05); padding: 20px; margin-bottom: 20px; }
        .table-responsive { overflow-x: auto; -webkit-overflow-scrolling: touch; border-radius: 8px; }
        .table-custom { width: 100%; min-width: 650px; }
        .table-custom th { background: #f9fafb; padding: 12px; font-weight: 600; font-size: 0.8rem; text-transform: uppercase; color: #6b7280; border-bottom: 2px solid #eee; }
        .table-custom td { padding: 12px; border-bottom: 1px solid #f3f4f6; vertical-align: middle; }
        .schedule-grid td { height: 100px; min-width: 140px; vertical-align: top; padding: 8px; border: 1px solid #eee; }
        .lesson-card { background: #e0e7ff; color: #3730a3; padding: 8px; border-radius: 6px; font-size: 0.8rem; margin-bottom: 4px; border-left: 4px solid var(--primary-color); cursor: pointer; }
        .btn-add-lesson { width: 100%; height: 100%; border: 2px dashed #ddd; background: transparent; color: #ccc; font-size: 24px; border-radius: 8px; }
        .big-journal-table input { text-align: center; font-weight: bold; border: 1px solid transparent; background: transparent; padding: 4px; border-radius: 4px; width: 100%; outline: none; }
        .big-journal-table input:focus { background: white; box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.2); }
    </style>
</head>
<body>

    <div id="guest-screen" class="access-denied">
        <div class="card p-5 shadow border-0" style="max-width: 400px; width: 90%;">
            <div class="mb-3 text-warning display-1"><i class="fas fa-clock"></i></div>
            <h4 class="fw-bold" data-key="guest_title">Kutilmoqda...</h4>
            <p class="text-muted small mb-4" data-key="guest_msg">Sizning hisobingiz administrator tasdig'ini kutmoqda.</p>
            <button onclick="logout()" class="btn btn-outline-danger w-100" data-key="btn_logout">Chiqish</button>
        </div>
    </div>

    <div class="overlay" id="sidebar-overlay" onclick="toggleSidebar()"></div>

    <div class="mobile-header">
        <button class="btn btn-light border btn-sm me-2" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
        <div class="fw-bold fs-6 text-primary me-auto" data-key="school_name_short">Al-Xorazmiy</div>
        <div class="d-flex align-items-center">
            <span class="lang-mini" onclick="setLang('uz')" data-lang="uz">UZ</span><span class="lang-sep">|</span><span class="lang-mini" onclick="setLang('ru')" data-lang="ru">RU</span>
        </div>
    </div>

    <nav class="sidebar" id="sidebar">
        <div class="brand">
            <span class="brand-text" data-key="school_name">Al-Xorazmiy CRM</span>
            <div class="d-none d-md-block">
                <span class="lang-mini" onclick="setLang('uz')" data-lang="uz">UZ</span><span class="lang-sep">|</span><span class="lang-mini" onclick="setLang('ru')" data-lang="ru">RU</span>
            </div>
            <button class="btn btn-sm btn-light d-md-none" onclick="toggleSidebar()"><i class="fas fa-times"></i></button>
        </div>
        
        <div class="menu-items">
            <div id="menu-admin" style="display: none;">
                <small class="text-muted fw-bold text-uppercase d-block px-2 mb-2" style="font-size:0.7rem" data-key="menu_manage">Boshqaruv</small>
                <button onclick="navTo('adm-schedule')" class="menu-btn active" id="btn-adm-schedule"><i class="fas fa-calendar-alt text-primary"></i> <span data-key="menu_grid">Dars jadvali</span></button>
                <button onclick="navTo('adm-students')" class="menu-btn" id="btn-adm-students"><i class="fas fa-user-graduate text-success"></i> <span data-key="menu_students">O'quvchilar</span></button>
                <button onclick="navTo('adm-users')" class="menu-btn" id="btn-adm-users"><i class="fas fa-chalkboard-teacher text-warning"></i> <span data-key="menu_teachers">O'qituvchilar</span></button>
                <button onclick="navTo('adm-reports')" class="menu-btn" id="btn-adm-reports"><i class="fas fa-chart-pie text-info"></i> <span data-key="menu_reports">Hisobotlar</span></button>
                <button onclick="navTo('adm-settings')" class="menu-btn" id="btn-adm-settings"><i class="fas fa-cogs text-secondary"></i> <span data-key="menu_settings">Sozlamalar</span></button>
            </div>

            <div id="menu-teacher" style="display: none;">
                <small class="text-muted fw-bold text-uppercase d-block px-2 mb-2" style="font-size:0.7rem" data-key="menu_my_lessons">Mening darslarim</small>
                <button onclick="loadSchedule(true); closeSidebar()" class="menu-btn active" id="btn-teach-today"><i class="fas fa-clock text-primary"></i> <span data-key="menu_today">Bugun</span></button>
                <button onclick="loadSchedule(false); closeSidebar()" class="menu-btn" id="btn-teach-week"><i class="fas fa-calendar-week text-primary"></i> <span data-key="menu_week">Hafta</span></button>
                <hr class="my-3 mx-2">
                <small class="text-muted fw-bold text-uppercase d-block px-2 mb-2" style="font-size:0.7rem" data-key="menu_journal">Jurnal</small>
                <button onclick="navTo('teacher-big-journal')" class="menu-btn" id="btn-teach-journal"><i class="fas fa-book-open text-success"></i> <span data-key="menu_big_journal">Katta Jurnal</span></button>
                <button onclick="navTo('adm-reports')" class="menu-btn" id="btn-teach-reports"><i class="fas fa-chart-bar text-info"></i> <span data-key="menu_performance">O'zlashtirish</span></button>
            </div>
        </div>

        <div class="user-profile">
            <div class="d-flex align-items-center gap-2 mb-3">
                <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center fw-bold" style="width: 35px; height: 35px;" id="user-avatar">?</div>
                <div class="overflow-hidden">
                    <div class="fw-bold text-truncate" id="greeting-msg" style="font-size: 0.85rem;">User</div>
                    <div class="text-muted small" id="user-role" style="font-size: 0.75rem;">Role</div>
                </div>
            </div>
            <div class="row g-2">
                <div class="col-6"><button onclick="openChangePass()" class="btn btn-sm btn-light border w-100" title="Parol">üîê</button></div>
                <div class="col-6"><button onclick="logout()" class="btn btn-sm btn-outline-danger w-100"><i class="fas fa-sign-out-alt"></i></button></div>
            </div>
        </div>
    </nav>

    <main class="main-content">
        
        <div id="section-schedule" style="display: none;">
            <h4 class="fw-bold mb-3" data-key="title_my_schedule">Mening darslarim</h4>
            <div class="card-custom">
                <div class="table-responsive">
                    <table class="table-custom table table-hover">
                        <thead><tr><th data-key="col_time">Vaqt</th><th data-key="col_class">Sinf</th><th data-key="col_subject">Fan</th><th data-key="col_room">Xona</th><th></th></tr></thead>
                        <tbody id="schedule-list"></tbody>
                    </table>
                </div>
                <div id="no-lessons-msg" class="text-center py-4 text-muted" style="display:none;" data-key="msg_no_lessons">Bugun darslar yo'q</div>
            </div>
        </div>

        <div id="section-journal" style="display: none;">
            <div class="d-flex align-items-center mb-3">
                <button class="btn btn-light border me-3" onclick="navTo('schedule')"><i class="fas fa-arrow-left"></i></button>
                <h4 class="m-0 fw-bold" id="journal-title">Dars</h4>
            </div>
            <div class="card-custom">
                <div class="d-flex gap-2 mb-3 overflow-auto">
                    <button class="btn btn-primary" id="tab-grades" onclick="switchTab('grades')" data-key="tab_grades">Baholar</button>
                    <button class="btn btn-light border" id="tab-attendance" onclick="switchTab('attendance')" data-key="tab_attendance">Davomat</button>
                </div>
                <div class="table-responsive">
                    <table class="table-custom table"><tbody id="journal-students-list"></tbody></table>
                </div>
            </div>
        </div>

        <div id="section-teacher-big-journal" style="display: none;">
            <h4 class="fw-bold mb-3" data-key="title_big_journal">Katta Jurnal</h4>
            <div class="card-custom">
                <div class="row g-2 mb-3">
                    <div class="col-12 col-md-3"><select id="big-journal-class" class="form-select class-dropdown"></select></div>
                    <div class="col-12 col-md-3"><select id="big-journal-subject" class="form-select subject-dropdown"></select></div>
                    <div class="col-6 col-md-3"><select id="big-journal-period" class="form-select"><option value="1 –ß–µ—Ç–≤–µ—Ä—Ç—å">1-Chorak</option><option value="2 –ß–µ—Ç–≤–µ—Ä—Ç—å">2-Chorak</option><option value="3 –ß–µ—Ç–≤–µ—Ä—Ç—å">3-Chorak</option><option value="4 –ß–µ—Ç–≤–µ—Ä—Ç—å">4-Chorak</option></select></div>
                    <div class="col-6 col-md-3"><button onclick="loadBigJournal()" class="btn btn-primary w-100" data-key="btn_load">Yuklash</button></div>
                </div>
                <div class="table-responsive">
                    <table class="table table-bordered text-center align-middle big-journal-table" style="font-size: 0.85rem;"><thead class="table-light"><tr id="big-journal-head"></tr></thead><tbody id="big-journal-body"></tbody></table>
                </div>
            </div>
        </div>

        <div id="section-adm-students" style="display: none;">
            <h4 class="fw-bold mb-3" data-key="menu_students">O'quvchilar</h4>
            <div class="row g-3">
                <div class="col-md-8">
                    <div class="card-custom">
                        <div class="d-flex gap-2 mb-3"><select id="filter-class-select" class="form-select class-dropdown" onchange="loadAdminStudents()"></select><button onclick="loadAdminStudents()" class="btn btn-primary"><i class="fas fa-sync"></i></button></div>
                        <div class="table-responsive"><table class="table-custom table table-hover"><thead><tr><th data-key="col_fio">F.I.O</th><th data-key="col_class">Sinf</th><th></th></tr></thead><tbody id="admin-students-list"></tbody></table></div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card-custom bg-primary text-white mb-3">
                        <h6 class="fw-bold mb-3" data-key="title_add">Qo'shish</h6>
                        <input id="new-name" class="form-control form-control-sm mb-2" placeholder="F.I.O">
                        <select id="new-class-select" class="form-select form-select-sm mb-2 class-dropdown"></select>
                        <button onclick="addOneStudent()" class="btn btn-light btn-sm w-100 fw-bold" data-key="btn_save">Saqlash</button>
                    </div>
                    <div class="card-custom">
                        <h6 class="fw-bold mb-3" data-key="title_import">Import Excel</h6>
                        <select id="import-class-select" class="form-select form-select-sm mb-2 class-dropdown"></select>
                        <input type="file" id="excel-file" class="form-control form-control-sm mb-2">
                        <button onclick="uploadExcel()" class="btn btn-success btn-sm w-100" data-key="btn_upload">Yuklash</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="section-adm-users" style="display: none;">
            <h4 class="fw-bold mb-3" data-key="menu_teachers">Foydalanuvchilar</h4>
            <div class="card-custom">
                <div class="bg-light p-3 rounded mb-3">
                    <div class="row g-2">
                        <div class="col-md-4"><input id="new-user-email" class="form-control form-control-sm" placeholder="Email"></div>
                        <div class="col-md-4"><input type="password" id="new-user-pass" class="form-control form-control-sm" placeholder="Parol"></div>
                        <div class="col-md-3"><select id="new-user-role" class="form-select form-select-sm"><option value="TEACHER">O'qituvchi</option><option value="ADMIN">Admin</option></select></div>
                        <div class="col-md-1"><button onclick="createNewUser()" class="btn btn-primary btn-sm w-100">+</button></div>
                    </div>
                </div>
                <div class="table-responsive"><table class="table-custom table"><thead><tr><th>Email</th><th data-key="col_role">Rol</th><th>Status</th><th>Action</th></tr></thead><tbody id="users-list"></tbody></table></div>
            </div>
        </div>

        <div id="section-adm-schedule" style="display: none;">
            <h4 class="fw-bold mb-3" data-key="menu_grid">Dars jadvali</h4>
            <div class="card-custom">
                <div class="d-flex gap-2 mb-3"><select id="editor-teacher-select" class="form-select" onchange="loadEditorGrid()"></select><button onclick="loadEditorGrid()" class="btn btn-primary"><i class="fas fa-sync"></i></button></div>
                <div class="table-responsive"><table class="table table-bordered text-center schedule-grid"><thead class="table-light"><tr><th>#</th><th data-key="day_mon">Du</th><th data-key="day_tue">Se</th><th data-key="day_wed">Ch</th><th data-key="day_thu">Pa</th><th data-key="day_fri">Ju</th><th data-key="day_sat">Sh</th></tr></thead><tbody id="schedule-grid-body"></tbody></table></div>
            </div>
        </div>

        <div id="section-adm-reports" style="display: none;">
            <h4 class="fw-bold mb-3" data-key="menu_reports">Hisobotlar</h4>
            <div class="card-custom">
                <div class="row g-2 mb-3 bg-light p-2 rounded mx-0">
                    <div class="col-6 col-md-3"><select id="report-class-select" class="form-select form-select-sm class-dropdown"></select></div>
                    <div class="col-6 col-md-3"><select id="report-type-select" class="form-select form-select-sm"><option value="grades">Baholar</option><option value="attendance">Davomat</option></select></div>
                    <div class="col-6 col-md-2"><input type="date" id="report-start" class="form-control form-control-sm"></div>
                    <div class="col-6 col-md-2"><input type="date" id="report-end" class="form-control form-control-sm"></div>
                    <div class="col-12 col-md-2 d-flex gap-1"><button onclick="loadReport(false)" class="btn btn-primary btn-sm flex-grow-1">Show</button><button onclick="loadReport(true)" class="btn btn-success btn-sm flex-grow-1">Excel</button></div>
                </div>
                <div class="table-responsive" id="report-result-container" style="display:none"><table class="table-custom table text-center"><thead class="table-light"><tr id="report-table-head"></tr></thead><tbody id="report-table-body"></tbody></table></div>
            </div>
        </div>

        <div id="section-adm-settings" style="display: none;">
            <h4 class="fw-bold mb-3" data-key="menu_settings">Sozlamalar</h4>
            <div class="row g-3">
                <div class="col-md-6"><div class="card-custom"><h6 class="fw-bold mb-3" data-key="sub_bells">Qo'ng'iroqlar</h6><ul class="list-group list-group-flush mb-3" id="bells-list"></ul><div class="input-group input-group-sm"><span class="input-group-text">#</span><input type="number" id="new-bell-order" class="form-control" placeholder="1"><input type="time" id="new-bell-start" class="form-control"><input type="time" id="new-bell-end" class="form-control"><button onclick="addBell()" class="btn btn-primary">+</button></div></div></div>
                <div class="col-md-6"><div class="card-custom"><h6 class="fw-bold mb-3" data-key="sub_dirs">Ma'lumotnomalar</h6><div class="input-group input-group-sm mb-2"><input id="new-class-name" class="form-control" placeholder="10-A"><button onclick="addClass()" class="btn btn-info text-white">+</button></div><div class="input-group input-group-sm"><input id="new-subject-name" class="form-control" placeholder="Matematika"><button onclick="addSubject()" class="btn btn-danger text-white">+</button></div></div></div>
            </div>
        </div>

    </main>

    <div class="modal fade" id="universalModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="modalTitle">...</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body" id="modalBody">...</div><div class="modal-footer pt-0 border-0" id="modalFooter"></div></div></div></div>
    
    <div class="d-none">
        <div id="change-pass-tpl"><input type="password" id="cp-old" class="form-control mb-2" placeholder="********"><input type="password" id="cp-new" class="form-control" placeholder="********"><div class="text-end mt-3"><button onclick="submitPasswordChange()" class="btn btn-success btn-sm" data-key="btn_save">OK</button></div></div>
        
        <div id="add-lesson-tpl">
            <p class="text-muted small" id="modal-lesson-info-tpl"></p>
            <input type="hidden" id="modal-day"><input type="hidden" id="modal-start"><input type="hidden" id="modal-end">
            <label class="small mt-2" data-key="col_class">Sinf</label><select id="modal-class" class="form-select mb-2 class-dropdown"></select>
            <label class="small" data-key="col_subject">Fan</label><select id="modal-subject" class="form-select mb-2 subject-dropdown"></select>
            <label class="small" data-key="col_room">Xona</label><input type="text" id="modal-room" class="form-control">
            <div id="schedule-error" class="text-danger small mt-2"></div>
            <button onclick="saveLessonFromModal()" class="btn btn-primary w-100 mt-3" data-key="btn_save">Saqlash</button>
        </div>
        
        <div id="transfer-tpl"><p class="fw-bold" id="transfer-name"></p><label class="small" data-key="col_class">Sinf</label><select id="transfer-class" class="form-select mb-3 class-dropdown"></select><button onclick="confirmTransfer()" class="btn btn-warning w-100">Transfer</button></div>
        
        <div id="edit-user-tpl">
            <input type="hidden" id="edit-user-id"><label class="small">Email</label><input id="edit-user-email" class="form-control mb-2">
            <label class="small" data-key="col_role">Rol</label><select id="edit-user-role" class="form-select mb-2"><option value="TEACHER">TEACHER</option><option value="ADMIN">ADMIN</option></select>
            <label class="small">New Password</label><input type="password" id="edit-user-pass" class="form-control mb-2" placeholder="******">
            <div class="form-check"><input class="form-check-input" type="checkbox" id="edit-user-active"><label class="form-check-label">Active</label></div>
            <div class="text-end mt-3"><button onclick="saveUserChanges()" class="btn btn-primary btn-sm" data-key="btn_save">Save</button></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const token = localStorage.getItem('token');
        if (!token) window.location.href = "/login";
        const uniModal = new bootstrap.Modal(document.getElementById('universalModal'));

        // === LOCALIZATION ===
        let currentLang = localStorage.getItem('lang') || 'uz';
        const translations = {
            uz: {
                school_name: "Al-Xorazmiy Maktabi", school_name_short: "Al-Xorazmiy",
                menu_manage: "BOSHQARUV", menu_grid: "Dars jadvali", menu_students: "O'quvchilar", menu_teachers: "O'qituvchilar", menu_reports: "Hisobotlar", menu_settings: "Sozlamalar",
                menu_my_lessons: "MENING DARSLARIM", menu_today: "Bugun", menu_week: "Hafta", menu_journal: "JURNAL", menu_big_journal: "Katta Jurnal", menu_performance: "O'zlashtirish",
                btn_pass: "Parol o'zgartirish", btn_logout: "Chiqish", btn_save: "Saqlash", title_my_schedule: "Mening darslarim", msg_no_lessons: "Darslar yo'q",
                col_time: "Vaqt", col_class: "Sinf", col_subject: "Fan", col_room: "Xona", col_fio: "F.I.O", col_role: "Rol",
                tab_grades: "Baholar", tab_attendance: "Davomat", title_big_journal: "Choraklik Jurnal", btn_load: "Yuklash", title_add: "Qo'shish", title_import: "Excel Import", btn_upload: "Yuklash",
                day_mon:"Du", day_tue:"Se", day_wed:"Ch", day_thu:"Pa", day_fri:"Ju", day_sat:"Sh", sub_bells: "Qo'ng'iroqlar", sub_dirs: "Ma'lumotnomalar",
                sel_teacher: "-- O'qituvchini tanlang --", sel_class: "-- Sinfni tanlang --", sel_subj: "-- Fanni tanlang --",
                guest_title: "Kutilmoqda...", guest_msg: "Sizning hisobingiz administrator tasdig'ini kutmoqda."
            },
            ru: {
                school_name: "–®–∫–æ–ª–∞ –ê–ª—å-–•–æ—Ä–µ–∑–º–∏", school_name_short: "–ê–ª—å-–•–æ—Ä–µ–∑–º–∏",
                menu_manage: "–£–ü–†–ê–í–õ–ï–ù–ò–ï", menu_grid: "–°–µ—Ç–∫–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è", menu_students: "–£—á–µ–Ω–∏–∫–∏", menu_teachers: "–£—á–∏—Ç–µ–ª—è", menu_reports: "–û—Ç—á–µ—Ç—ã", menu_settings: "–ù–∞—Å—Ç—Ä–æ–π–∫–∏",
                menu_my_lessons: "–ú–û–ò –£–†–û–ö–ò", menu_today: "–°–µ–≥–æ–¥–Ω—è", menu_week: "–ù–µ–¥–µ–ª—è", menu_journal: "–ñ–£–†–ù–ê–õ", menu_big_journal: "–°–≤–æ–¥–Ω—ã–π –ñ—É—Ä–Ω–∞–ª", menu_performance: "–£—Å–ø–µ–≤–∞–µ–º–æ—Å—Ç—å",
                btn_pass: "–°–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å", btn_logout: "–í—ã–π—Ç–∏", btn_save: "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å", title_my_schedule: "–ú–æ—ë —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ", msg_no_lessons: "–ù–µ—Ç —É—Ä–æ–∫–æ–≤",
                col_time: "–í—Ä–µ–º—è", col_class: "–ö–ª–∞—Å—Å", col_subject: "–ü—Ä–µ–¥–º–µ—Ç", col_room: "–ö–∞–±.", col_fio: "–§–ò–û", col_role: "–†–æ–ª—å",
                tab_grades: "–û—Ü–µ–Ω–∫–∏", tab_attendance: "–ü–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å", title_big_journal: "–°–≤–æ–¥–Ω—ã–π –∂—É—Ä–Ω–∞–ª", btn_load: "–ó–∞–≥—Ä—É–∑–∏—Ç—å", title_add: "–î–æ–±–∞–≤–∏—Ç—å", title_import: "–ò–º–ø–æ—Ä—Ç Excel", btn_upload: "–ó–∞–≥—Ä—É–∑–∏—Ç—å",
                day_mon:"–ü–Ω", day_tue:"–í—Ç", day_wed:"–°—Ä", day_thu:"–ß—Ç", day_fri:"–ü—Ç", day_sat:"–°–±", sub_bells: "–ó–≤–æ–Ω–∫–∏", sub_dirs: "–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏",
                sel_teacher: "-- –í—ã–±–µ—Ä–∏—Ç–µ —É—á–∏—Ç–µ–ª—è --", sel_class: "-- –í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∞—Å—Å --", sel_subj: "-- –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç --",
                guest_title: "–û–∂–∏–¥–∞–Ω–∏–µ...", guest_msg: "–í–∞—à –∞–∫–∫–∞—É–Ω—Ç –æ–∂–∏–¥–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞."
            }
        };

        function setLang(lang) {
            currentLang = lang; localStorage.setItem('lang', lang);
            document.querySelectorAll('.lang-mini').forEach(el => el.classList.remove('active'));
            document.querySelectorAll(`.lang-mini[data-lang="${lang}"]`).forEach(el => el.classList.add('active'));
            
            document.querySelectorAll('[data-key]').forEach(el => {
                const key = el.getAttribute('data-key');
                if(translations[lang][key]) el.innerText = translations[lang][key];
            });
            loadSettingsData(); 
        }

        // === UI & NAV ===
        function toggleSidebar(forceClose = false) {
            const sb = document.getElementById('sidebar'); const ov = document.getElementById('sidebar-overlay');
            if (forceClose) { sb.classList.remove('active'); ov.classList.remove('active'); }
            else { sb.classList.toggle('active'); ov.classList.toggle('active'); }
        }
        function closeSidebar() { toggleSidebar(true); }
        function navTo(id) {
            document.querySelectorAll('main > div').forEach(el => el.style.display = 'none');
            const target = document.getElementById('section-' + id);
            if (target) target.style.display = 'block';
            document.querySelectorAll('.menu-btn').forEach(b => b.classList.remove('active'));
            const btn = document.getElementById('btn-' + (id==='schedule'?'teach-today':id));
            if(btn) btn.classList.add('active');
            if(id === 'adm-users') loadUsers();
            if(id === 'adm-students') loadAdminStudents();
            if (window.innerWidth <= 768) closeSidebar();
        }
        function openChangePass() {
            document.getElementById('modalTitle').innerText = translations[currentLang].btn_pass;
            document.getElementById('modalBody').innerHTML = document.getElementById('change-pass-tpl').innerHTML;
            uniModal.show();
        }

        // === GLOBAL VARS & INIT ===
        let userRole = "", classesList = [], subjectsList = [], currentStudents = [], currentSubjectId = null, currentMode = 'grades', selectedStudentId = null;
        const daysMap = ["–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫", "–í—Ç–æ—Ä–Ω–∏–∫", "–°—Ä–µ–¥–∞", "–ß–µ—Ç–≤–µ—Ä–≥", "–ü—è—Ç–Ω–∏—Ü–∞", "–°—É–±–±–æ—Ç–∞"];

        async function init() {
            setLang(currentLang);
            const r = await fetch('/auth/me', { headers: { 'Authorization': 'Bearer ' + token } });
            if(!r.ok) { window.location.href = "/login"; return; }
            const u = await r.json(); userRole = u.role;
            document.getElementById('greeting-msg').innerText = u.email.split('@')[0];
            document.getElementById('user-role').innerText = u.role;
            document.getElementById('user-avatar').innerText = u.email[0].toUpperCase();
            
            if (userRole === 'GUEST') { document.getElementById('guest-screen').style.display = 'flex'; return; }

            await loadSettingsData();
            if (u.role === 'ADMIN') { document.getElementById('menu-admin').style.display = 'block'; navTo('adm-schedule'); }
            else { document.getElementById('menu-teacher').style.display = 'block'; loadSchedule(true); }
        }

        async function loadSettingsData() {
            const h = { headers: { 'Authorization': 'Bearer ' + token } };
            const rb = await fetch('/settings/bells/', h); if(rb.ok) renderBells(await rb.json());
            const rc = await fetch('/classes/', h); if(rc.ok) { classesList = await rc.json(); fillDropdowns('class-dropdown', classesList); }
            const rs = await fetch('/settings/subjects/', h); if(rs.ok) { subjectsList = await rs.json(); fillDropdowns('subject-dropdown', subjectsList); }
            if(userRole === 'ADMIN') {
                const ru = await fetch('/auth/users', h);
                if(ru.ok) {
                    const us = await ru.json(); const teachers = us.filter(u => u.role === 'TEACHER');
                    const sel = document.getElementById('editor-teacher-select');
                    if(sel) { const val = sel.value; sel.innerHTML=`<option value="">${translations[currentLang].sel_teacher}</option>`; teachers.forEach(t=>{sel.innerHTML+=`<option value="${t.id}">${t.email}</option>`}); if(val) sel.value = val; }
                }
            }
        }

        function fillDropdowns(cls, list) {
            const ph_cls = translations[currentLang].sel_class; const ph_subj = translations[currentLang].sel_subj;
            document.querySelectorAll('.'+cls).forEach(s => {
                const val = s.value; s.innerHTML=`<option value="">${s.classList.contains('subject-dropdown') ? ph_subj : ph_cls}</option>`;
                list.forEach(i=>{s.innerHTML+=`<option value="${i.id}">${i.name}</option>`}); if(val) s.value = val;
            });
        }

        // === TEACHER FEATURES ===
        async function loadSchedule(today) {
            navTo('schedule'); document.getElementById('btn-teach-week').classList.remove('active'); document.getElementById(today ? 'btn-teach-today' : 'btn-teach-week').classList.add('active');
            const dname = daysMap[new Date().getDay()===0?6:new Date().getDay()-1];
            let url = '/schedule/'; if(today) url+=`?day=${dname}`;
            const r = await fetch(url, { headers: { 'Authorization': 'Bearer ' + token } }); const lessons = await r.json();
            const tb = document.getElementById('schedule-list'); tb.innerHTML='';
            if(!lessons.length) document.getElementById('no-lessons-msg').style.display='block';
            else {
                document.getElementById('no-lessons-msg').style.display='none';
                lessons.forEach(l => { const isToday = l.day_of_week === dname; tb.innerHTML += `<tr><td><b>${l.start_time}</b><br><small class="text-muted">${l.day_of_week}</small></td><td><span class="badge bg-light text-dark border">${l.class_group_name}</span></td><td class="text-primary fw-bold">${l.subject_name}</td><td>${l.room_number}</td><td><button class="btn btn-sm ${isToday?'btn-primary':'btn-secondary disabled'}" ${isToday?'':'disabled'} onclick="openJournal(${l.class_group_id}, '${l.class_group_name}', ${l.subject_id}, '${l.subject_name}')">Journal</button></td></tr>`; });
            }
        }
        async function openJournal(cid, cname, sid, sname) { currentSubjectId=sid; document.getElementById('journal-title').innerText = `${cname} | ${sname}`; navTo('journal'); switchTab('grades'); const r = await fetch(`/students/?class_id=${cid}`,{headers:{'Authorization':'Bearer '+token}}); currentStudents = await r.json(); renderJournal(); }
        function switchTab(m) { currentMode=m; document.getElementById('tab-grades').className = m==='grades'?'btn btn-primary':'btn btn-light border'; document.getElementById('tab-attendance').className = m==='attendance'?'btn btn-primary':'btn btn-light border'; renderJournal(); }
        function renderJournal() {
            const tb=document.getElementById('journal-students-list'); tb.innerHTML='';
            currentStudents.forEach(s => {
                const acts = currentMode==='grades' ? `<div class="btn-group btn-group-sm"><button onclick="sendD(${s.id},5,this)" class="btn btn-outline-success">5</button><button onclick="sendD(${s.id},4,this)" class="btn btn-outline-primary">4</button><button onclick="sendD(${s.id},3,this)" class="btn btn-outline-warning">3</button><button onclick="sendD(${s.id},2,this)" class="btn btn-outline-danger">2</button></div>` : `<div class="btn-group btn-group-sm"><button onclick="sendD(${s.id},'PRESENT',this)" class="btn btn-outline-success"><i class="fas fa-check"></i></button><button onclick="sendD(${s.id},'ABSENT',this)" class="btn btn-outline-danger">N/B</button></div>`;
                tb.innerHTML+=`<tr><td class="fw-bold">${s.full_name}</td><td class="text-end">${acts}</td></tr>`;
            });
        }
        async function sendD(sid, val, btn) {
            const d=new Date().toISOString().split('T')[0]; const u=currentMode==='grades'?'/grades/':'/attendance/'; const b=currentMode==='grades'?{value:val, student_id:sid, subject_id:currentSubjectId, date:d}:{status:val, student_id:sid, date:d};
            btn.parentElement.querySelectorAll('.btn').forEach(x=>x.classList.remove('active')); btn.classList.add('active');
            await fetch(u,{method:'POST', headers:{'Content-Type':'application/json','Authorization':'Bearer '+token}, body:JSON.stringify(b)});
        }
        async function loadBigJournal() {
            const cid=document.getElementById('big-journal-class').value; const sid=document.getElementById('big-journal-subject').value; const per=document.getElementById('big-journal-period').value;
            if(!cid||!sid) return;
            const r = await fetch(`/grades/matrix?class_id=${cid}&subject_id=${sid}&period_name=${per}`, { headers: { 'Authorization': 'Bearer ' + token } }); const data = await r.json();
            const th=document.getElementById('big-journal-head'); th.innerHTML='<th class="text-start" style="min-width:150px">F.I.O</th>';
            data.dates.forEach(d => { th.innerHTML+=`<th style="min-width:40px;font-size:0.75rem">${d.split('-')[2]}.${d.split('-')[1]}</th>`; });
            th.innerHTML+=`<th class="bg-light text-primary">Sr</th><th class="bg-warning bg-opacity-10">Res</th>`;
            const tb=document.getElementById('big-journal-body'); tb.innerHTML='';
            data.students.forEach(s => {
                let row=`<td class="text-start fw-bold">${s.full_name}</td>`;
                data.dates.forEach(d => { const g=s.grades[d]||''; let c=g==5?'text-success':(g==2?'text-danger':'text-muted'); row+=`<td class="${c} fw-bold">${g}</td>`; });
                row+=`<td class="fw-bold bg-light ${s.average<3&&s.average>0?'text-danger':'text-primary'}">${s.average}</td>`;
                row+=`<td class="bg-warning bg-opacity-10 p-0"><input value="${s.final_grade||''}" onchange="saveFinalGrade(${s.student_id},this.value)"></td>`;
                tb.innerHTML+=`<tr>${row}</tr>`;
            });
        }
        async function saveFinalGrade(sid,val) { await fetch('/grades/final', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token }, body: JSON.stringify({ student_id: sid, subject_id: document.getElementById('big-journal-subject').value, period_name: document.getElementById('big-journal-period').value, value: val }) }); }

        // === ADMIN & EDIT FEATURES ===
        async function addOneStudent() {
            const n=document.getElementById('new-name'); const c=document.getElementById('new-class-select');
            if(!n.value || !c.value) return;
            const res = await fetch('/students/',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+token},body:JSON.stringify({full_name:n.value, class_group_id:c.value})});
            if(res.ok) { n.value=''; loadAdminStudents(); }
        }
        async function createNewUser() {
            const e=document.getElementById('new-user-email'); const p=document.getElementById('new-user-pass'); const r=document.getElementById('new-user-role');
            if(!e.value || !p.value) return;
            const res = await fetch('/auth/register',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email:e.value, password:p.value, role:r.value})});
            if(res.ok) { e.value=''; p.value=''; loadUsers(); loadSettingsData(); }
        }
        async function loadAdminStudents() { const cid=document.getElementById('filter-class-select').value; const r=await fetch(`/students/${cid?'?class_id='+cid:''}`,{headers:{'Authorization':'Bearer '+token}}); const d=await r.json(); const tb=document.getElementById('admin-students-list'); tb.innerHTML=''; d.forEach(s=>{ const c=classesList.find(x=>x.id==s.class_group_id)?.name||'-'; tb.innerHTML+=`<tr><td>${s.full_name}</td><td><span class="badge bg-light text-dark border">${c}</span></td><td class="text-end"><button class="btn btn-sm btn-outline-warning me-1" onclick="openTransfer(${s.id},'${s.full_name}')"><i class="fas fa-exchange-alt"></i></button><button class="btn btn-sm btn-outline-danger" onclick="deleteStudent(${s.id})"><i class="fas fa-trash"></i></button></td></tr>`; }); }
        
        // --- UPDATED: Load Users with DELETE button ---
        async function loadUsers() { 
            const r=await fetch('/auth/users',{headers:{'Authorization':'Bearer '+token}}); 
            const d=await r.json(); 
            const tb=document.getElementById('users-list'); 
            tb.innerHTML=''; 
            d.forEach(u=>{ 
                tb.innerHTML+=`<tr>
                    <td>${u.email}</td>
                    <td><span class="badge ${u.role==='ADMIN'?'bg-danger':'bg-primary'}">${u.role}</span></td>
                    <td>${u.is_active?'‚úÖ':'‚ùå'}</td>
                    <td>
                        <button class="btn btn-sm btn-light border me-1" onclick="openEditUser(${u.id},'${u.email}','${u.role}',${u.is_active})"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-danger" onclick="deleteUser(${u.id})"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>`; 
            }); 
        }

        // --- NEW: Delete User Function ---
        async function deleteUser(id) {
            if(confirm("Haqiqatan ham ushbu foydalanuvchini o'chirmoqchimisiz?")) {
                const res = await fetch(`/auth/delete/${id}`, {
                    method: 'POST',
                    headers: {'Authorization': 'Bearer ' + token}
                });
                if(res.ok) {
                    loadUsers();
                } else {
                    const err = await res.json();
                    alert("Xatolik: " + err.detail);
                }
            }
        }

        async function deleteStudent(id) { if(confirm("O'chirilsinmi?")) { await fetch(`/students/${id}`,{method:'DELETE',headers:{'Authorization':'Bearer '+token}}); loadAdminStudents(); } }
        async function addClass() { const i=document.getElementById('new-class-name'); await fetch('/settings/classes/?name='+i.value,{method:'POST',headers:{'Authorization':'Bearer '+token}}); i.value=''; loadSettingsData(); }
        async function addSubject() { const i=document.getElementById('new-subject-name'); await fetch('/settings/subjects/?name='+i.value,{method:'POST',headers:{'Authorization':'Bearer '+token}}); i.value=''; loadSettingsData(); }
        
        async function loadEditorGrid() {
            const tid = document.getElementById('editor-teacher-select').value; const tb = document.getElementById('schedule-grid-body'); tb.innerHTML=''; if (!tid) return;
            const res = await fetch(`/schedule/?teacher_id=${tid}`, { headers: { 'Authorization': 'Bearer ' + token } }); const lessons = await res.json();
            const bellsRes = await fetch('/settings/bells/', { headers: { 'Authorization': 'Bearer ' + token } }); const bells = await bellsRes.json();
            bells.forEach(bell => {
                let row = `<tr><td class="bg-light fw-bold">${bell.order}<br><small>${bell.start_time}</small></td>`;
                daysMap.forEach(day => {
                    const l = lessons.find(x => x.day_of_week === day && x.start_time === bell.start_time);
                    if (l) row += `<td><div class="lesson-card" onclick="deleteLesson(${l.id})"><strong>${l.subject_name}</strong><br>${l.class_group_name}</div></td>`;
                    else row += `<td><button class="btn-add-lesson" onclick="prepAddLesson('${day}','${bell.start_time}','${bell.end_time}')">+</button></td>`;
                });
                tb.innerHTML += row + '</tr>';
            });
        }
        function prepAddLesson(d, s, e) {
            document.getElementById('modalTitle').innerText = translations[currentLang].title_add;
            document.getElementById('modalBody').innerHTML = document.getElementById('add-lesson-tpl').innerHTML;
            const mb = document.getElementById('modalBody');
            mb.querySelector('#modal-day').value=d; mb.querySelector('#modal-start').value=s; mb.querySelector('#modal-end').value=e; mb.querySelector('#modal-lesson-info-tpl').innerText = `${d}, ${s} - ${e}`;
            fillDropdowns('class-dropdown', classesList); fillDropdowns('subject-dropdown', subjectsList);
            uniModal.show();
        }
        window.saveLessonFromModal = async function() {
            const mb = document.getElementById('modalBody'); const tid = document.getElementById('editor-teacher-select').value;
            const body = { teacher_id: tid, day_of_week: mb.querySelector('#modal-day').value, start_time: mb.querySelector('#modal-start').value, end_time: mb.querySelector('#modal-end').value, class_group_id: mb.querySelector('#modal-class').value, subject_id: mb.querySelector('#modal-subject').value, room_number: mb.querySelector('#modal-room').value };
            const r = await fetch('/schedule/', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token }, body: JSON.stringify(body) });
            if (r.ok) { uniModal.hide(); loadEditorGrid(); } else { const e = await r.json(); mb.querySelector('#schedule-error').innerText = "‚õî " + e.detail; }
        }
        async function deleteLesson(id) { if(confirm("Delete?")) { await fetch(`/schedule/${id}`, { method: 'DELETE', headers: { 'Authorization': 'Bearer ' + token } }); loadEditorGrid(); } }

        // === EDIT USER & TRANSFER MODALS ===
        function openEditUser(id, e, r, a) {
            document.getElementById('modalTitle').innerText = "Edit User";
            document.getElementById('modalBody').innerHTML = document.getElementById('edit-user-tpl').innerHTML;
            const mb = document.getElementById('modalBody');
            mb.querySelector('#edit-user-id').value = id; mb.querySelector('#edit-user-email').value = e;
            mb.querySelector('#edit-user-role').value = r; mb.querySelector('#edit-user-active').checked = a;
            uniModal.show();
        }
        window.saveUserChanges = async function() {
            const mb = document.getElementById('modalBody');
            const id = mb.querySelector('#edit-user-id').value;
            const p = mb.querySelector('#edit-user-pass').value;
            const body = { email: mb.querySelector('#edit-user-email').value, role: mb.querySelector('#edit-user-role').value, is_active: mb.querySelector('#edit-user-active').checked };
            if (p) body.password = p;
            await fetch(`/auth/users/${id}`,{method:'PUT',headers:{'Content-Type':'application/json','Authorization':'Bearer '+token},body:JSON.stringify(body)});
            uniModal.hide(); loadUsers();
        }
        function openTransfer(id, name) {
            selectedStudentId = id;
            document.getElementById('modalTitle').innerText = "Transfer Student";
            document.getElementById('modalBody').innerHTML = document.getElementById('transfer-tpl').innerHTML;
            const mb = document.getElementById('modalBody');
            mb.querySelector('#transfer-name').innerText = name;
            fillDropdowns('class-dropdown', classesList);
            uniModal.show();
        }
        window.confirmTransfer = async function() {
            const mb = document.getElementById('modalBody');
            const newClass = mb.querySelector('#transfer-class').value;
            if(!newClass) return;
            await fetch(`/students/${selectedStudentId}/transfer?new_class_id=${newClass}`,{method:'PUT',headers:{'Authorization':'Bearer '+token}});
            uniModal.hide(); loadAdminStudents();
        }

        // UTILS
        function renderBells(list) { const l=document.getElementById('bells-list'); l.innerHTML=''; list.forEach(b=>{ l.innerHTML+=`<li class="list-group-item d-flex justify-content-between border-0 bg-light mb-1 rounded"><span><span class="badge bg-primary me-2">${b.order}</span> ${b.start_time} - ${b.end_time}</span><button onclick="delBell(${b.id})" class="btn btn-sm text-danger"><i class="fas fa-trash"></i></button></li>`; }); }
        async function delBell(id) { await fetch(`/settings/bells/${id}`,{method:'DELETE',headers:{'Authorization':'Bearer '+token}}); loadSettingsData(); }
        async function submitPasswordChange() { const body = document.getElementById('modalBody'); const o = body.querySelector('#cp-old').value; const n = body.querySelector('#cp-new').value; const res = await fetch('/auth/change-password', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token }, body: JSON.stringify({ old_password: o, new_password: n }) }); if(res.ok) { uniModal.hide(); } }
        function logout() { localStorage.removeItem('token'); window.location.href="/"; }
        init();
    </script>
</body>
</html>